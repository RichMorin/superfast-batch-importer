package org.neo4j.batchimport.newimport.structs;

import java.util.ArrayList;
import java.util.List;

import org.neo4j.batchimport.newimport.DataBuffers;
import org.neo4j.batchimport.newimport.utils.Utils;

public class DiskRecordsBuffer {
	int type, arrayIndex, qIndex;
	public int curEntries, maxEntries;
	public List<Object>[] records = null;
	boolean isLastBuf = false, inUse = false;
	public DiskRecordsBuffer(int type, int entries, int arrayIndex){
		this.maxEntries = entries;
		this.type = type;
		this.arrayIndex = arrayIndex;
		List[] recs = new ArrayList[this.maxEntries];
		for (int i = 0; i < this.maxEntries; i++)
			recs[i] = new ArrayList<>();
		records = recs;	
		DataBuffers.BufferCounts.upCount("DiskRecords");
		DataBuffers.BufferCounts.upCount("DiskRecords-maxEntries", this.maxEntries);
	}
	public boolean isLastBuffer(){
		return isLastBuf;
	}
	public void setLastBuffer(boolean lastBuffer){
		isLastBuf = lastBuffer;
	}

	public int extend(int entries) {
		if (entries <= maxEntries)
			return 0;
		
		List<Object>[] newRecords = new ArrayList[entries];
		System.arraycopy(this.records, 0, newRecords, 0, this.records.length);
		for (int i =  records.length; i < entries; i++)
			newRecords[i] = new ArrayList<>();
		records = newRecords;
		DataBuffers.BufferCounts.upCount("DiskRecords-maxEntries", entries-this.maxEntries);
		maxEntries = entries;
		return maxEntries;
	}
	public int addRecord(Object rec, int index){
			records[index].add(rec);
			return records[index].size()-1;
	}
	public int addRecord(long id, Object rec, int index){
		records[index].add(rec);
		return records[index].size()-1;
	}
	public void cleanup(){  
		inUse = false;
		curEntries = 0;
		for (int i = 0; i < this.maxEntries; i++)
			records[i].clear();
		if ((Runtime.getRuntime().freeMemory()/Utils.mb) < 100)
			System.gc();
	}	
}
